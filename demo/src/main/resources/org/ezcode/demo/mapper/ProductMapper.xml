<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.ezcode.demo.mapper.ProductMapper">


<sql id="ordrList">
<!-- 가격, 평점평균, 리뷰수, 날짜, 조회수 -->
  <choose>
    <when test="orderType == 'price'.toString()">
      p.price*1
    </when>
    <when test="orderType == 'avg'.toString()">
      ravg
    </when>
    <when test="orderType == 'cnt'.toString()">
      rcnt
    </when>
    <when test="orderType == 'hit'.toString()">
      hit
    </when>
    <when test="orderType == 'date'.toString()">
      p.regdate
    </when>
    <when test="orderType == 'pno'.toString()">
      p.pno
    </when>
    <when test="orderType eq null">
      p.pno
    </when>
  </choose>
</sql>

<select id="selectAll" resultMap="listMap">
  SELECT 
  p.pno, p.pname, p.price, p.seller, p.summary, p.regdate, p.hit, p.state, p.ctno,
  ifnull(round(avg(r.score), 1), 0) ravg, r.regdate, count(r.rvno) rcnt
  FROM 
  tbl_review r right outer join tbl_product p
  on r.pno = p.pno
  where p.pno > 0
  group by p.pno
  order by
  <include refid="ordrList"></include>
  desc
  limit #{skip}, #{amount}
</select>

<resultMap type="org.ezcode.demo.domain.ProductVO" id="listMap">
  <id column="pno" property="pno"/>
  <result column="pno" property="pno"/>
  <result column="pname" property="pname"/>
  <result column="price" property="price"/>
  <result column="seller" property="seller"/>
  <result column="summary" property="summary"/>
  <result column="regdate" property="regdate"/>
  <result column="hit" property="hit"/>
  <result column="state" property="state"/>
  <result column="ctno" property="ctno"/>
  <collection property="review" resultMap="reviewMap"></collection>
</resultMap>

<resultMap type="org.ezcode.demo.domain.ReviewVO" id="reviewMap">
	<result column="rvno" property="rvno"/>
	<result column="uid" property="uid"/>
	<result column="content" property="content"/>
	<result column="ravg" property="ravg"/>
	<result column="regdate" property="regdate"/>
	<result column="rcnt" property="rcnt"/>
</resultMap>

<select id="getCount" resultType="int">
    select 
    count(*)
    from
    tbl_product
    where pno > 0
</select>
</mapper>